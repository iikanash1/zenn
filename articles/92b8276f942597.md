---
title: "Squidãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®æ§‹ç¯‰æ‰‹é †ï¼šè©³ç´°ã‚¬ã‚¤ãƒ‰"
emoji: "ğŸ¦‘"
type: "tech"
topics: ["squid", "proxy", "server", "ã‚¤ãƒ³ãƒ•ãƒ©", "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯"]
published: true
---

# Squidãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®æ§‹ç¯‰æ‰‹é †

ã“ã®è¨˜äº‹ã§ã¯ã€Squidãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®æ§‹ç¯‰æ–¹æ³•ã«ã¤ã„ã¦ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‹ã‚‰è¨­å®šã€é‹ç”¨ã¾ã§ã‚’è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚Squidã¯é«˜æ€§èƒ½ãªãƒ—ãƒ­ã‚­ã‚·ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒãƒ¼ã§ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã«å½¹ç«‹ã¡ã¾ã™ã€‚

## ç›®æ¬¡
1. Squidã®æ¦‚è¦
2. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †
3. åŸºæœ¬è¨­å®š
4. ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
5. ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
6. HTTPSå¯¾å¿œ
7. é‹ç”¨ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

## 1. Squidã®æ¦‚è¦

Squidã¯ä»¥ä¸‹ã®ã‚ˆã†ãªç‰¹å¾´ã‚’æŒã¤ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã§ã™ï¼š
- Webãƒ—ãƒ­ã‚­ã‚·ã¨ã—ã¦ã®æ©Ÿèƒ½
- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°
- ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- SSL/TLSå¯¾å¿œ
- é«˜åº¦ãªãƒ­ã‚°æ©Ÿèƒ½

## 2. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †

### Ubuntu/Debianç³»ã®å ´åˆ

```bash
# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ›´æ–°
sudo apt update
sudo apt upgrade

# Squidã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo apt install squid

# ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ç¢ºèª
sudo systemctl status squid
```

### CentOS/RHELç³»ã®å ´åˆ

```bash
# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ›´æ–°
sudo yum update

# Squidã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo yum install squid

# ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ç¢ºèª
sudo systemctl status squid
```

## 3. åŸºæœ¬è¨­å®š

Squidã®ä¸»è¦ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ `/etc/squid/squid.conf` ã§ã™ã€‚ä»¥ä¸‹ã«åŸºæœ¬çš„ãªè¨­å®šä¾‹ã‚’ç¤ºã—ã¾ã™ï¼š

```conf
# ãƒãƒ¼ãƒˆè¨­å®š
http_port 3128

# ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã®è¨­å®š
access_log /var/log/squid/access.log squid

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®è¨­å®š
cache_mgr admin@example.com

# DNSã‚µãƒ¼ãƒãƒ¼ã®è¨­å®š
dns_nameservers 8.8.8.8 8.8.4.4

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®š
cache_dir ufs /var/spool/squid 100 16 256
```

## 4. ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

### ACLï¼ˆã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒªã‚¹ãƒˆï¼‰ã®è¨­å®š

```conf
# å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®å®šç¾©
acl localnet src 192.168.1.0/24
acl localnet src 10.0.0.0/8

# è¨±å¯ã™ã‚‹ãƒãƒ¼ãƒˆã®å®šç¾©
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 443         # https

# ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ«ãƒ¼ãƒ«
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localnet
http_access deny all
```

### èªè¨¼ã®è¨­å®š

```conf
# Basicèªè¨¼ã®è¨­å®š
auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwd
auth_param basic realm Proxy Authentication Required
acl authenticated proxy_auth REQUIRED
http_access allow authenticated
```

## 5. ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š

åŠ¹ç‡çš„ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥é‹ç”¨ã®ãŸã‚ã®è¨­å®šä¾‹ï¼š

```conf
# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¡ãƒ¢ãƒªã®è¨­å®š
cache_mem 256 MB

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ€å¤§ãƒ»æœ€å°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚µã‚¤ã‚º
maximum_object_size 4 MB
minimum_object_size 0 KB

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç½®ãæ›ãˆãƒãƒªã‚·ãƒ¼
cache_replacement_policy lru

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä¿æŒæœŸé–“
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
```

## 6. HTTPSå¯¾å¿œ

SSL Bumpã‚’ä½¿ç”¨ã—ãŸHTTPSé€šä¿¡ã®å‡¦ç†ï¼š

```conf
# SSLè¨¼æ˜æ›¸ã®è¨­å®š
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/ssl_db -M 4MB
sslcrtd_children 5

# SSL Bumpè¨­å®š
http_port 3128 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myca.pem key=/etc/squid/ssl_cert/myca.key

# SSL Bumpãƒ«ãƒ¼ãƒ«
acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all
```

## 7. é‹ç”¨ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

```bash
# logrotateã®è¨­å®šä¾‹
/var/log/squid/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    nocreate
    sharedscripts
    postrotate
        /usr/sbin/squid -k rotate
    endscript
}
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç®¡ç†

```bash
# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®åˆæœŸåŒ–
squid -z

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®çµ±è¨ˆæƒ…å ±ç¢ºèª
squidclient mgr:info

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªã‚¢
squid -k reconfigure
```

### æ€§èƒ½ç›£è¦–

```bash
# Squidã®çµ±è¨ˆæƒ…å ±ç¢ºèª
tail -f /var/log/squid/cache.log
squidclient mgr:5min
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•ï¼š

1. æ¥ç¶šã‚¨ãƒ©ãƒ¼
   - ãƒãƒ¼ãƒˆã®é–‹æ”¾ç¢ºèª
   - ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®è¨­å®šç¢ºèª
   - SELinuxã®è¨­å®šç¢ºèª

2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œ
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ç¢ºèª
   - ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã®ç¢ºèª
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å†åˆæœŸåŒ–

3. èªè¨¼ã‚¨ãƒ©ãƒ¼
   - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™ç¢ºèª
   - èªè¨¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¨­å®šç¢ºèª

## ã¾ã¨ã‚

ã“ã®è¨˜äº‹ã§ã¯ã€Squidãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®åŸºæœ¬çš„ãªæ§‹ç¯‰æ–¹æ³•ã‹ã‚‰ã€è©³ç´°ãªè¨­å®šã€é‹ç”¨ç®¡ç†ã¾ã§è§£èª¬ã—ã¾ã—ãŸã€‚å®Ÿéš›ã®ç’°å¢ƒã«å°å…¥ã™ã‚‹éš›ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã«å¿œã˜ã¦é©åˆ‡ãªè¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

## å‚è€ƒãƒªãƒ³ã‚¯
- [Squidå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](http://www.squid-cache.org/Doc/)
- [Squid Wiki](https://wiki.squid-cache.org/)
- [Squid FAQ](http://wiki.squid-cache.org/SquidFaq)
