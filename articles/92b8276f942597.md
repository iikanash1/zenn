---
title: "Squidプロキシサーバーの構築手順：詳細ガイド"
emoji: "🦑"
type: "tech"
topics: ["squid", "proxy", "server", "インフラ", "ネットワーク"]
published: true
---

# Squidプロキシサーバーの構築手順

この記事では、Squidプロキシサーバーの構築方法について、インストールから設定、運用までを詳しく解説します。Squidは高性能なプロキシキャッシュサーバーで、ネットワークのパフォーマンス向上やセキュリティ強化に役立ちます。

## 目次
1. Squidの概要
2. インストール手順
3. 基本設定
4. アクセス制御
5. キャッシュ設定
6. HTTPS対応
7. 運用とメンテナンス

## 1. Squidの概要

Squidは以下のような特徴を持つプロキシサーバーソフトウェアです：
- Webプロキシとしての機能
- コンテンツのキャッシング
- アクセス制御
- SSL/TLS対応
- 高度なログ機能

## 2. インストール手順

### Ubuntu/Debian系の場合

```bash
# パッケージの更新
sudo apt update
sudo apt upgrade

# Squidのインストール
sudo apt install squid

# サービスの状態確認
sudo systemctl status squid
```

### CentOS/RHEL系の場合

```bash
# パッケージの更新
sudo yum update

# Squidのインストール
sudo yum install squid

# サービスの状態確認
sudo systemctl status squid
```

## 3. 基本設定

Squidの主要な設定ファイルは `/etc/squid/squid.conf` です。以下に基本的な設定例を示します：

```conf
# ポート設定
http_port 3128

# アクセスログの設定
access_log /var/log/squid/access.log squid

# キャッシュマネージャーの設定
cache_mgr admin@example.com

# DNSサーバーの設定
dns_nameservers 8.8.8.8 8.8.4.4

# キャッシュディレクトリの設定
cache_dir ufs /var/spool/squid 100 16 256
```

## 4. アクセス制御

### ACL（アクセスコントロールリスト）の設定

```conf
# 内部ネットワークの定義
acl localnet src 192.168.1.0/24
acl localnet src 10.0.0.0/8

# 許可するポートの定義
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 443         # https

# アクセス制御ルール
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localnet
http_access deny all
```

### 認証の設定

```conf
# Basic認証の設定
auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwd
auth_param basic realm Proxy Authentication Required
acl authenticated proxy_auth REQUIRED
http_access allow authenticated
```

## 5. キャッシュ設定

効率的なキャッシュ運用のための設定例：

```conf
# キャッシュメモリの設定
cache_mem 256 MB

# キャッシュの最大・最小オブジェクトサイズ
maximum_object_size 4 MB
minimum_object_size 0 KB

# キャッシュ置き換えポリシー
cache_replacement_policy lru

# キャッシュの保持期間
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
```

## 6. HTTPS対応

SSL Bumpを使用したHTTPS通信の処理：

```conf
# SSL証明書の設定
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/ssl_db -M 4MB
sslcrtd_children 5

# SSL Bump設定
http_port 3128 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myca.pem key=/etc/squid/ssl_cert/myca.key

# SSL Bumpルール
acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all
```

## 7. 運用とメンテナンス

### ログローテーション

```bash
# logrotateの設定例
/var/log/squid/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    nocreate
    sharedscripts
    postrotate
        /usr/sbin/squid -k rotate
    endscript
}
```

### キャッシュの管理

```bash
# キャッシュディレクトリの初期化
squid -z

# キャッシュの統計情報確認
squidclient mgr:info

# キャッシュのクリア
squid -k reconfigure
```

### 性能監視

```bash
# Squidの統計情報確認
tail -f /var/log/squid/cache.log
squidclient mgr:5min
```

## トラブルシューティング

よくある問題と解決方法：

1. 接続エラー
   - ポートの開放確認
   - ファイアウォールの設定確認
   - SELinuxの設定確認

2. キャッシュ問題
   - キャッシュディレクトリの権限確認
   - ディスク容量の確認
   - キャッシュの再初期化

3. 認証エラー
   - パスワードファイルの権限確認
   - 認証モジュールの設定確認

## まとめ

この記事では、Squidプロキシサーバーの基本的な構築方法から、詳細な設定、運用管理まで解説しました。実際の環境に導入する際は、セキュリティ要件やネットワーク構成に応じて適切な設定を行ってください。

## 参考リンク
- [Squid公式ドキュメント](http://www.squid-cache.org/Doc/)
- [Squid Wiki](https://wiki.squid-cache.org/)
- [Squid FAQ](http://wiki.squid-cache.org/SquidFaq)
